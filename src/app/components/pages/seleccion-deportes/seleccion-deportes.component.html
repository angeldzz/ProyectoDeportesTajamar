<div class="loader-backdrop" *ngIf="loading">
  <div class="spinner"></div>
</div>

<div class="container-fluid bg-light-custom p-5">
  <div class="d-flex align-items-center justify-content-between mb-5">
    <div class="d-flex align-items-center">
      <div class="title-bar"></div>
      <h2 class="fw-bold m-0 ms-3" style="color: var(--text-main);">Actividades Disponibles</h2>
    </div>

    @if (((role$ | async) === 3 || (role$ | async) === 4 || (role$ | async) === 6) && !loading && !eventoPasado) {
      <button class="btn btn-sm btn-outline-warning d-flex align-items-center gap-2 opacity-75 custom-btn-rand"
              (click)="procesarActividades()"
              title="Prueba Aleatoria">
        <span class="small fw-bold">Random</span>
        <i class="bi bi-dice-5 fs-5"></i>
      </button>
    }
  </div>
  @if (loading) {
    <div class="d-flex flex-column align-items-center justify-content-center py-5">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <h5 class="mt-3 text-muted fw-bold">Cargando actividades...</h5>
    </div>
  } @else {
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-5">

      @for (deporte of deportes; track deporte.idActividad) {
        <div class="col">
          <div class="card border-0 shadow-sm h-100 bg-white overflow-hidden card-hover-simple position-relative">

            <div class="dropdown position-absolute top-0 end-0 m-3" style="z-index: 10;">
              <button
                class="btn btn-dark btn-sm rounded-circle no-caret shadow-none d-flex align-items-center justify-content-center"
                type="button"
                data-bs-toggle="dropdown"
                style="width: 32px; height: 32px; background: rgba(0,0,0,0.4); border: none;">
                <i class="bi bi-three-dots-vertical text-white"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-4 mt-2">
                <li>
                  <a class="dropdown-item py-2" [routerLink]="['/materiales', idEvento, deporte.idActividad]">
                    <i class="bi bi-box me-2"></i>Materiales
                  </a>
                </li>
                @if (((role$ | async) === 3 || (role$ | async) === 4 || (role$ | async) === 6) && !eventoPasado) {

                  <li>
                    <a class="preciodrop dropdown-item py-2"
                            data-bs-toggle="modal"
                            data-bs-target="#modalPrecio"
                            (click)="prepararModal(deporte.idEventoActividad, deporte.precio)">
                      <i class="bi bi-currency-euro me-1"></i>
                      {{ deporte.precio ? 'Editar Precio' : 'Asignar Precio' }}
                    </a>
                  </li>
                }
                <li>
                  <a class="dropdown-item py-2" [routerLink]="['/seleccionar-equipo', idEvento, deporte.idActividad]">
                    <i class="bi bi-people me-2"></i> Ver Equipos
                  </a>
                </li>

              </ul>
            </div>

            <div class="position-relative p-2">
              <img [src]="getImagenActividad(deporte.nombreActividad)"
                   class="card-img-top rounded-4 shadow-sm"
                   [alt]="deporte.nombreActividad"
                   style="height: 200px; object-fit: cover;"> <span class="badge position-absolute top-0 start-0 m-3 border-0 py-2 px-3 shadow-sm"
                                                                    [ngClass]="eventoPasado ? 'bg-danger' : 'badge-status'">
    {{ eventoPasado ? 'REGISTRO FINALIZADO' : 'REGISTRO ABIERTO' }}
  </span>

              @if (deporte.precio != null) {
                <span class="badge position-absolute bottom-0 start-0 m-3 py-1 px-3 fw-bold badge-sport-type">
                  {{ deporte.precio.precioTotal }} €
                </span>
              }
            </div>

            <div class="card-body d-flex flex-column p-4">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="fw-bold m-0" style="color: var(--text-main); font-size: 1.1rem;">
                  {{ deporte.nombreActividad }}
                </h5>
                <span class="badge rounded-pill bg-primary-subtle text-primary border border-primary-subtle px-2 py-1 d-flex align-items-center"
                      title="Mínimo de jugadores"
                      style="font-size: 0.75rem; white-space: nowrap;">
                <i class="bi bi-people-fill me-1"></i>
                Min: {{ deporte.minimoJugadores }}
              </span>
              </div>

              <hr class="text-secondary opacity-25 mb-4 mt-auto">

              <div class="d-flex justify-content-center align-items-center">
                @if (!eventoPasado) {
                  <button type="button"
                          class="btn px-5 py-2 fw-bold shadow-sm"
                          [ngClass]="yaInscrito ? 'btn-secondary' : 'btn-primary'"
                          data-bs-toggle="modal"
                          [attr.data-bs-target]="yaInscrito ? null : '#modalCapitan'"
                          [disabled]="yaInscrito"
                          (click)="yaInscrito ? null : abrirModalCapitan(deporte)">

                    @if (yaInscrito) {
                      <i class="bi bi-check-circle-fill me-2"></i> Ya estás inscrito
                    } @else {
                      Inscríbete!!
                    }

                  </button>
                } @else {
                  <span class="text-muted small fw-bold text-uppercase">Inscripciones cerradas</span>
                }
                </div>
            </div>
          </div>
        </div>

      } @empty {
        <div class="col-12 w-100 text-center py-5">
          <div class="p-5 bg-white rounded-4 shadow-sm border">
            <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
            <h3 class="mt-3 fw-bold" style="color: var(--text-main);">No hay actividades</h3>
            <p class="text-muted">No se han encontrado actividades disponibles para este evento.</p>
            <button class="btn btn-outline-primary mt-2" [routerLink]="['/']">
              <i class="bi bi-arrow-clockwise me-1"></i> Volver
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>




<!--MODAL PRECIO-->
<div class="modal fade" id="modalPrecio" tabindex="-1" aria-labelledby="modalPrecioLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">

      <div class="modal-header bg-light border-0 py-3">
        <h5 class="modal-title fw-bold" id="modalPrecioLabel">
          <i class="bi" [class.bi-pencil-square]="idPrecioSeleccionado"
             [class.bi-plus-circle]="!idPrecioSeleccionado"></i>
          {{ idPrecioSeleccionado ? 'Editar Precio' : 'Crear Nuevo Precio' }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4">
        <form>
          <div class="mb-3">
            <label class="form-label fw-bold small text-muted text-uppercase">Importe (€)</label>
            <input type="text"
                   name="precio"
                   [(ngModel)]="precioInput"
                   class="form-control form-control-lg bg-light border-0 rounded-3"
                   placeholder="0.00">
            <div class="form-text">
              ID Actividad: {{ idEventoActividadActual }}
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer border-0 p-3">
        <button type="button" #btnCerrar class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary rounded-3 px-4 shadow-sm" (click)="guardarPrecio()">
          {{ idPrecioSeleccionado ? 'Actualizar' : 'Guardar' }}
        </button>
      </div>


    </div>
  </div>
</div>

<!--MODAL INSCRIPCION-->
<div
  class="modal fade"
  id="modalCapitan"
  tabindex="-1"
  aria-labelledby="modalCapitanLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCapitanLabel">
          ¿Quieres ser capitán del evento?
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <div class="form-check">
          <input
            id="chkCapitan"
            class="form-check-input"
            type="checkbox"
            [(ngModel)]="quiereSerCapitan"
            (change)="onChangeCapitan()"
          />
          <label class="form-check-label" for="chkCapitan">
            Sí, quiero ser capitán del evento
          </label>
        </div>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal">
          Cerrar
        </button>

        <button
          type="button"
          class="btn btn-primary"
          data-bs-dismiss="modal"
          (click)="inscribirseDesdeModal()"
          [disabled]=" yaInscrito || eventoPasado"
        >
          Inscribirse
        </button>
      </div>
    </div>
  </div>
</div>
